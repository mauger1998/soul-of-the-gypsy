---
import { urlForImage } from '../../lib/urlForImage'
const { image, title, text, index, sticker } = Astro.props
---

<div data-speed={1 - index / 50} class="project">
	{
		sticker ? (
			<img class="sticker" src={urlForImage(sticker).format('webp').url()} alt={sticker.alt} />
		) : (
			''
		)
	}
	<div class="mask">
		<img src={urlForImage(image).format('webp').url()} alt={image.alt} />
		<dialog>
			<img src={urlForImage(image).format('webp').url()} alt={image.alt} />
		</dialog>
	</div>
	<div class="text">
		<h3>{title}</h3>
		<p>{text}</p>
	</div>
</div>

<script>
	import { gsap } from 'gsap'
	import { ScrollTrigger } from 'gsap/ScrollTrigger'
	gsap.registerPlugin(ScrollTrigger)

	if ('ontouchstart' in window) {
		const projects = document.querySelectorAll('.project')
		projects.forEach((project) => {
			project.removeAttribute('data-speed')
		})
	}

	const allStickers = document.querySelectorAll('.project .sticker')

	allStickers.forEach((sticker) => {
		gsap.to(sticker, {
			scrollTrigger: {
				trigger: sticker,
				start: 'top bottom',
				toggleActions: 'play none none reverse'
			},
			scale: 1,
			transformOrigin: 'center'
		})
	})

	const allMasks = document.querySelectorAll('.project .mask')
	const allMaskDialogs = document.querySelectorAll('.project .mask dialog')

	allMasks.forEach((mask, index) => {
		mask.addEventListener('click', () => {
			allMaskDialogs[index].showModal()
		})
		document.addEventListener('click', (event) => {
			if (event.target === allMaskDialogs[index]) {
				allMaskDialogs[index].close()
			}
		})
	})
</script>

<style lang="scss">
	.project {
		position: relative;

		& > img {
			max-width: 75px;
			position: absolute;
			z-index: 1;
			top: -2rem;
			right: -2rem;
			scale: 0;
		}
		.mask {
			overflow: hidden;
			display: flex;

			dialog {
				position: fixed;
				width: 80vw;
				height: 90vh;
				background-color: $white;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				overflow: hidden;

				&:focus {
					outline: none;
				}

				img {
					width: 100%;
					height: 100%;
					object-fit: cover;
					margin: 0;
					padding: 0;
				}
				&::backdrop {
					background-color: #030303b5;
				}
			}

			& > img {
				clip-path: polygon(0 0, 0 0, 0 100%, 0% 100%);
				scale: 1.1;
				transition: 300ms scale ease-in-out;
				object-fit: cover;
				cursor: pointer;
			}

			&:hover {
				& > img {
					scale: 1.075 !important;
					transition: 300ms scale ease-in-out;
				}
			}
		}

		.text {
			transform: translateY(2rem);
			opacity: 0;
			h3 {
				color: $white;
				margin-block: 0.75rem 1rem;
			}
			p {
				max-width: 40ch;
			}
		}
	}
</style>
